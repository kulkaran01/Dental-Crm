document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION & INITIAL STATE ---

    const WORKFLOW_TEXT = `{
Hereâ€™s the **clear, practical, step-by-step daily workflow** for selling high-ticket dental websites â€” designed exactly for your strengths (fast design, good templates, respectful communication).

If you follow this routine for 7â€“14 days, you will close clients.

Letâ€™s build the entire system.

---

# â­ **PART 1 â€” Your Daily Workflow (Exact Routine)**

### **â° NIGHT (Research + Create Free Samples)**

This is when you silently prepare your sales weapons.

### **STEP 1 â€” Pick ONLY 4â€“5 clinics**

Use Google Maps:

* â€œDental clinicâ€
* â€œCosmetic dentistâ€
* â€œImplant dentistâ€
* â€œAligners dentistâ€
* â€œSmile makeover clinicâ€
* â€œVeneers specialistâ€

Select clinics where:
âœ” Their website looks outdated
âœ” Or they have **no website**
âœ” Or their gallery is weak
âœ” Or their design doesnâ€™t match the clinic quality
âœ” Or they have good photos but poor site

Pick the ones with:

* Good Google reviews (â‰¥4.3)
* Good interior photos
* High-ticket keywords (aligners/implants/cosmetic)

These convert best.

---

### **STEP 2 â€” Create ONE Homepage Mockup (10â€“15 mins each)**

Using Figma AI or your usual builder, make:

* Hero section
* Doctor photo
* Before/After section
* Reviews section
* WhatsApp CTA
* Premium colour palette

Not full website â€” just ONE SECTION.
Small preview = enough to impress.

Export as screenshot.

---

### **STEP 3 â€” Prepare personalized message**

Write a note for each doctor:

â€œDoctor, I saw your reviews and your clinic looks premium â€” but your website doesnâ€™t show that quality.
So I made a modern sample preview to show whatâ€™s possible for your high-ticket patients.â€

---

### **Your goal at night:**

âœ” Prepare 4â€“5 previews
âœ” Prepare 4â€“5 messages
âœ” Save 4â€“5 clinic WhatsApp numbers

---

# â­ **PART 2 â€” MORNING / AFTERNOON (Calling + Sending Previews)**

### **STEP 1 â€” Call the clinic (4â€“5 calls total)**

When receptionist answers:

**You say:**
â€œMaâ€™am, who handles your clinicâ€™s website or online enquiries? The doctor or the clinic manager?â€

â†’ This gives you the decision maker name.

If they say:
â€œDoctor is busy.â€

**You say:**
â€œPerfectly fine maâ€™am. I made a small 10-second homepage preview for your clinic.
Could I send it to your WhatsApp number?â€

They ALWAYS give WhatsApp.

---

### **STEP 2 â€” Immediately send your preview**

Send:

\`\`\`
Doctor, I made a modern homepage preview for your clinic.
It builds trust for high-ticket treatments like implants and aligners.

Here is the sample ðŸ‘‡
\`\`\`

Attach screenshot.

---

### **STEP 3 â€” Ask ONE tiny question**

Within 30 seconds, send:

\`\`\`
Do you want me to create a full homepage version for you? I can share it for free.
\`\`\`

This is bait â€” easy to say yes to.

---

# â­ **PART 3 â€” Follow-Up Workflow (How many messages, when to send, what to say)**

### **AFTER 2 HOURS**

Send:

\`\`\`
Doctor, did you get a chance to see the preview?
I can upgrade your high-ticket treatment pages too â€” implants, veneers, aligners.
\`\`\`

---

### **NEXT MORNING (if no reply)**

Send:

\`\`\`
Doctor, one quick question:
Do you want a premium or simple website style?

I can show you both options with your clinic photos.
\`\`\`

This boosts reply rate massively because doctors like comparison choices.

---

### **AFTER 3 DAYS (final soft close)**

Send:

\`\`\`
Doctor, Iâ€™ll close your preview file today. 
Should I keep it ready if you plan to upgrade this month?
\`\`\`

This triggers urgency without pressure.

---

# â­ **PART 4 â€” What type of clients you'll face & how to handle each**

Youâ€™ll face **3 types** of dental clinics.

---

## **TYPE A â€” They have NO website**

They know they need one but have been delaying.

**What they fear:**

* Cost
* Technical hassle
* Wasting money

**What to say:**

â€œDoctor, Iâ€™ll handle everything â€” content, design, photos, hosting.
You just approve layout. You get a website that helps convert high-ticket cases.â€

These close FAST.

---

## **TYPE B â€” They have a BAD / outdated website**

This is your best target.

**Pain points:**

* Looks old
* Weak gallery
* No credibility
* No mobile responsiveness
* Slow site
* No treatment pages

**What to say:**

â€œDoctor, your clinic looks premium but the website doesnâ€™t show that.
High-ticket patients judge within 3 seconds. Thatâ€™s why I made you a preview.â€

These close with **visual comparison**.

---

## **TYPE C â€” They have a GOOD website (rare)**

But usually:

* They want landing pages
* They want appointment flow improvement
* They want treatment-specific pages
* They want better branding

**What to say:**

â€œDoctor, Iâ€™ll rebuild only your high-ticket pages (aligners/implants/veneers) to increase case acceptance.â€

These pay high.

---

# â­ **PART 5 â€” How much time will clients engage?**

### **Doctors are busy â†’ they reply late**

They work:

* Mornings
* Evenings

They reply mostly:

* Night 9 PMâ€“11 PM
* Early morning 7 AMâ€“9 AM

Don't panic if they donâ€™t reply â€” it's normal.

---

### **They donâ€™t get fed up**

Many clients reply after:

* 2 days
* 4 days
* Even 1 week

As long as your messages are:

* respectful
* short
* helpful
* not needy

Youâ€™re fine.

---

# â­ **PART 6 â€” When should you aim to close?**

### **Not Day 1.**

Day 1 is for:

* showing value
* building trust
* proving you understand their clinic

### **Day 2â€“4 is perfect for closing.**

If they show interest on Day 1: great.
If not: Day 2 follow-up usually converts.

---

# â­ **PART 7 â€” What should you offer free vs paid?**

### **FREE**

âœ” 1 homepage preview screenshot
âœ” 1 second preview (treatment or gallery) if needed
âœ” Light color branding suggestions
âœ” 1â€“2 WhatsApp messages answering questions

### **PAID (Your actual service)**

âœ” full website
âœ” full copywriting
âœ” full treatment pages (aligners, implants, veneers)
âœ” gallery optimization
âœ” WhatsApp automation
âœ” booking integration
âœ” hosting/domain setup
âœ” SEO structure

Never give the full prototype for free.

Only give **one section**.
This is your bait to open the conversation.

---

# â­ **PART 8 â€” Your Perfect Daily Schedule (Simple version)**

### **â° NIGHT (1â€“2 hours)**

* Find 4â€“5 clinics
* Make 4â€“5 previews
* Prepare personalized messages

### **â° MORNING (45â€“60 minutes)**

* Call 4â€“5 clinics
* Get WhatsApp
* Send previews

### **â° AFTERNOON (15 minutes)**

* Send soft follow-up
* Ask for feedback

### **â° EVENING (20 minutes)**

* Offer full homepage
* Offer treatment pages
* Soft close
`

    const MESSAGE_TEMPLATES = [
        {
            title: "Initial Preview Message",
            content: `Doctor, I made a modern homepage preview for your clinic.\nIt builds trust for high-ticket treatments like implants and aligners.\n\nHere is the sample ðŸ‘‡`
        },
        {
            title: "Follow-Up Question (After Preview)",
            content: `Do you want me to create a full homepage version for you? I can share it for free.`
        },
        {
            title: "Follow-Up (After 2 Hours)",
            content: `Doctor, did you get a chance to see the preview?\nI can upgrade your high-ticket treatment pages too â€” implants, veneers, aligners.`
        },
        {
            title: "Follow-Up (Next Morning)",
            content: `Doctor, one quick question:\nDo you want a premium or simple website style?\n\nI can show you both options with your clinic photos.`
        },
        {
            title: "Follow-Up (After 3 Days - Soft Close)",
            content: `Doctor, Iâ€™ll close your preview file today. \nShould I keep it ready if you plan to upgrade this month?`
        }
    ];

    const CONTACT_TYPES = ["Receptionist", "Doctor Personal", "Clinic General", "Emergency", "Other"];

    const COLD_CALL_SCRIPT = [
        "Ask who handles the clinicâ€™s website or online enquiries (Doctor or Manager).",
        "If doctor is busy, ask to send a 10-second homepage preview to their WhatsApp.",
        "Get the WhatsApp number.",
    ];

    const COLUMNS = [
        "Night (Preparation)", 
        "Morning (Contact)", 
        "Follow-up (2hr)",
        "Follow-up (Next Day)", 
        "Follow-up (3 Day)",
        "Interested", 
        "Closed - Won", 
        "Closed - Lost"
    ];

    // --- DOM ELEMENT REFERENCES ---
    
    const board = document.getElementById('board');
    const addClinicBtn = document.getElementById('add-clinic-btn');
    const modal = document.getElementById('clinic-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('clinic-form');
    const saveBtn = document.getElementById('save-clinic-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const deleteBtn = document.getElementById('delete-clinic-btn');
    const clinicStatusSelect = document.getElementById('clinic-status');
    const contactNumbersContainer = document.getElementById('contact-numbers-container'); // Added
    const addContactNumberBtn = document.getElementById('add-contact-number-btn'); // Added

    const workflowModal = document.getElementById('workflow-modal');
    const viewWorkflowBtn = document.getElementById('view-workflow-btn');
    const closeWorkflowBtn = document.getElementById('close-workflow-btn');
    const workflowContent = document.getElementById('workflow-content');

    const messageTemplatesContainer = document.getElementById('message-templates');
    
    const aiSummarizeBtn = document.getElementById('ai-summarize-btn');
    const aiInput = document.getElementById('ai-input');
    const aiOutput = document.getElementById('ai-output');


    // --- DATA HANDLING ---

    const getClinics = async () => {
        try {
            const response = await fetch('/api/clinics');
            if (!response.ok) throw new Error('Failed to fetch clinics');
            return await response.json();
        } catch (error) {
            console.error(error);
            return []; // Return empty array on error
        }
    };

    const saveClinics = async (clinics) => {
        try {
            await fetch('/api/clinics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clinics, null, 2) // Pretty-print the JSON
            });
        } catch (error) {
            console.error('Failed to save clinics:', error);
        }
    };

    // --- CORE APPLICATION LOGIC ---

    const updateStats = async () => {
        let clinics = await getClinics();

        // Calculate active leads (not won or lost)
        const activeClinics = clinics.filter(c =>
            !c.status.includes('Closed')
        );

        // Calculate won this week (you can enhance this with actual date tracking)
        const wonClinics = clinics.filter(c => c.status === 'Closed - Won');

        // Calculate conversion rate
        const totalClosed = clinics.filter(c => c.status.includes('Closed'));
        const conversionRate = totalClosed.length > 0
            ? Math.round((wonClinics.length / totalClosed.length) * 100)
            : 0;

        // Update DOM
        document.getElementById('stat-active').textContent = activeClinics.length;
        document.getElementById('stat-won').textContent = wonClinics.length;
        document.getElementById('stat-rate').textContent = conversionRate + '%';
    };

    const renderBoard = async () => {
        board.innerHTML = '';
        let clinics = await getClinics();

        COLUMNS.forEach(columnName => {
            const columnEl = document.createElement('div');
            columnEl.className = 'column';

            const filteredClinics = clinics.filter(c => c.status === columnName);
            const count = filteredClinics.length;

            columnEl.innerHTML = `
                <div class="column-header">${columnName} <span style="opacity: 0.7; font-weight: 600;">(${count})</span></div>
                <div class="clinic-cards" data-status="${columnName}"></div>
            `;

            const cardsContainer = columnEl.querySelector('.clinic-cards');

            filteredClinics.forEach(clinic => {
                const card = createClinicCard(clinic);
                cardsContainer.appendChild(card);
            });

            board.appendChild(columnEl);
        });

        // Update stats after rendering board
        await updateStats();
    };

    const createClinicCard = (clinic) => {
        const card = document.createElement('div');
        card.className = `clinic-card card-type-${clinic.clientType}`;
        card.setAttribute('data-id', clinic.id);

        let contactInfo = 'N/A';
        if (clinic.contacts && clinic.contacts.length > 0) {
            const primaryContact = clinic.contacts[0];
            contactInfo = `${primaryContact.type}: ${primaryContact.number}`;
        }

        card.innerHTML = `
            <h4>${clinic.name}</h4>
            <div class="card-details">
                <p><strong>Doctor:</strong> ${clinic.doctorName || 'N/A'}</p>
                <p><strong>Contact:</strong> ${contactInfo}</p>
            </div>
        `;
        card.addEventListener('click', () => openModal(clinic.id));
        return card;
    };
    
    const renderColdCallChecklist = (savedState = {}) => {
        const container = document.getElementById('cold-call-checklist');
        container.innerHTML = '';
        COLD_CALL_SCRIPT.forEach((item, index) => {
            const isChecked = savedState[index] === true;
            const el = document.createElement('div');
            el.className = 'checklist-item';
            el.innerHTML = `
                <input type="checkbox" id="checklist-${index}" data-index="${index}" ${isChecked ? 'checked' : ''}>
                <label for="checklist-${index}">${item}</label>
            `;
            container.appendChild(el);
        });
    };

    const renderContactNumbers = (contacts = []) => {
        contactNumbersContainer.innerHTML = ''; // Clear existing fields
        if (contacts.length === 0) {
            addContactNumberField(); // Add one blank field if none exist
            return;
        }
        contacts.forEach(contact => addContactNumberField(contact.type, contact.number));
    };

    const addContactNumberField = (type = '', number = '') => {
        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'contact-number-group'; // For potential styling

        const typeSelect = document.createElement('select');
        typeSelect.className = 'contact-type-select';
        CONTACT_TYPES.forEach(contactType => {
            const option = document.createElement('option');
            option.value = contactType;
            option.textContent = contactType;
            if (contactType === type) {
                option.selected = true;
            }
            typeSelect.appendChild(option);
        });

        const numberInput = document.createElement('input');
        numberInput.type = 'tel';
        numberInput.className = 'contact-number-input';
        numberInput.value = number;
        numberInput.placeholder = 'Phone number';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-contact-number-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => removeContactNumberField(fieldGroup));

        fieldGroup.appendChild(typeSelect);
        fieldGroup.appendChild(numberInput);
        fieldGroup.appendChild(removeBtn);
        contactNumbersContainer.appendChild(fieldGroup);
    };

    const removeContactNumberField = (fieldGroup) => {
        fieldGroup.remove();
    };

    const openModal = async (clinicId = null) => {
        form.reset();
        deleteBtn.style.display = 'none';
        aiInput.value = '';
        aiOutput.innerHTML = ''; // Ensure innerHTML for AI output

        if (clinicId) {
            // Editing existing clinic
            modalTitle.textContent = 'Edit Clinic';
            let clinics = await getClinics();
            const clinic = clinics.find(c => c.id === clinicId);

            document.getElementById('clinic-id').value = clinic.id;
            document.getElementById('clinic-name').value = clinic.name;
            document.getElementById('doctor-name').value = clinic.doctorName;
            
            renderContactNumbers(clinic.contacts); // Render dynamic contact fields

            document.getElementById('clinic-website').value = clinic.website;
            document.getElementById('client-type').value = clinic.clientType;
            document.getElementById('clinic-status').value = clinic.status;
            document.getElementById('clinic-notes').value = clinic.notes;
            
            renderColdCallChecklist(clinic.coldCallChecklist);
            deleteBtn.style.display = 'inline-block';
        } else {
            // Adding new clinic
            modalTitle.textContent = 'Add New Clinic';
            document.getElementById('clinic-id').value = '';
            document.getElementById('clinic-status').value = COLUMNS[0]; // Default to first column
            renderContactNumbers(); // Render one blank field
            renderColdCallChecklist(); // Render empty checklist
        }
        
        modal.style.display = 'flex';
    };

    const closeModal = () => {
        modal.style.display = 'none';
    };
    
    const saveClinic = async (e) => {
        e.preventDefault();
        let clinics = await getClinics();
        const id = document.getElementById('clinic-id').value;

        // Collect dynamic contact numbers
        const contacts = [];
        document.querySelectorAll('.contact-number-group').forEach(group => {
            const type = group.querySelector('.contact-type-select').value;
            const number = group.querySelector('.contact-number-input').value.trim();
            if (number) { // Only save if number is not empty
                contacts.push({ type, number });
            }
        });

        // Save checklist state
        const coldCallChecklist = {};
        document.querySelectorAll('#cold-call-checklist input[type="checkbox"]').forEach(checkbox => {
            coldCallChecklist[checkbox.dataset.index] = checkbox.checked;
        });

        const clinicData = {
            name: document.getElementById('clinic-name').value,
            doctorName: document.getElementById('doctor-name').value,
            contacts: contacts, // Use the new dynamic contacts array
            website: document.getElementById('clinic-website').value,
            clientType: document.getElementById('client-type').value,
            status: document.getElementById('clinic-status').value,
            notes: document.getElementById('clinic-notes').value,
            coldCallChecklist: coldCallChecklist,
        };

        if (id) {
            // Update existing
            const index = clinics.findIndex(c => c.id === id);
            clinics[index] = { ...clinics[index], ...clinicData, id: id };
        } else {
            // Create new
            clinicData.id = `clinic_${Date.now()}`;
            clinics.push(clinicData);
        }

        await saveClinics(clinics);
        await renderBoard();
        closeModal();
    };

    const deleteClinic = async () => {
        const id = document.getElementById('clinic-id').value;
        if (confirm('Are you sure you want to delete this clinic?')) {
            let clinics = await getClinics();
            clinics = clinics.filter(c => c.id !== id);
            await saveClinics(clinics);
            await renderBoard();
            closeModal();
        }
    };
    
    const populateStatusDropdown = () => {
        clinicStatusSelect.innerHTML = '';
        COLUMNS.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            clinicStatusSelect.appendChild(option);
        });
    };

    const populateMessageTemplates = () => {
        messageTemplatesContainer.innerHTML = '';
        MESSAGE_TEMPLATES.forEach(template => {
            const el = document.createElement('div');
            el.className = 'template';
            el.innerHTML = `
                <div class="template-content">${template.content}</div>
                <button class="copy-btn">Copy</button>
            `;
            el.querySelector('.copy-btn').addEventListener('click', (e) => {
                navigator.clipboard.writeText(template.content);
                const btn = e.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = originalText, 1500);
            });
            messageTemplatesContainer.appendChild(el);
        });
    };

    const populateWorkflowModal = () => {
        workflowContent.textContent = WORKFLOW_TEXT;
    };
    
    // --- AI INTEGRATION ---
    
    /**
     * This is a placeholder for calling the DeepSeek API.
     * You need to replace 'DEEPSEEK_API_KEY' with your actual key from the config.js file.
     */
    async function getAiSummary(text) {
        // Check if the API key is set
        if (!config.DEEPSEEK_API_KEY || config.DEEPSEEK_API_KEY === 'PASTE_YOUR_DEEPSEEK_API_KEY_HERE') {
            return "Error: DeepSeek API key not found. Please add it to the config.js file.";
        }

        const prompt = `Summarize the following conversation with a dental clinic. Format the output as a concise list of bullet points. Extract key points, the client's sentiment (positive, negative, neutral), and suggest a next step based on the sales workflow provided.

Conversation:
${text}`;
        
        try {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat", // Or another model you prefer
                    messages: [
                        { "role": "system", "content": "You are a helpful assistant for a salesperson selling websites to dental clinics. You always respond in clear, concise bullet points." },
                        { "role": "user", "content": prompt }
                    ],
                    max_tokens: 200,
                    temperature: 0.5,
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("DeepSeek API Error:", errorData);
                return `Error from API: ${errorData.error.message}`;
            }

            const data = await response.json();
            // Convert markdown-style bullets to HTML
            return data.choices[0].message.content.trim().replace(/\* /g, '<li>').replace(/\n/g, '</li>');

        } catch (error) {
            console.error('Failed to fetch from DeepSeek API:', error);
            return 'Failed to connect to the AI service. Check the console for details.';
        }
    }

    const handleAiSummarize = async () => {
        const text = aiInput.value.trim();
        if (!text) {
            aiOutput.innerHTML = 'Please paste a conversation transcript first.';
            return;
        }

        aiOutput.innerHTML = 'AI is thinking...';
        const summary = await getAiSummary(text);
        aiOutput.innerHTML = `<ul>${summary}</ul>`;
        
        // Optional: Append to notes
        const notesField = document.getElementById('clinic-notes');
        notesField.value += `\n\n--- AI Summary ---\n${summary.replace(/<li>/g, '\n* ').replace(/<\/li>/g, '')}\n--------------------`;
    };


    // --- EVENT LISTENERS ---

    addClinicBtn.addEventListener('click', () => openModal());
    cancelBtn.addEventListener('click', closeModal);
    form.addEventListener('submit', saveClinic);
    deleteBtn.addEventListener('click', deleteClinic);
    addContactNumberBtn.addEventListener('click', () => addContactNumberField());

    viewWorkflowBtn.addEventListener('click', () => workflowModal.style.display = 'flex');
    closeWorkflowBtn.addEventListener('click', () => workflowModal.style.display = 'none');
    
    aiSummarizeBtn.addEventListener('click', handleAiSummarize);

    // Close modals on outside click
    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
        if (e.target === workflowModal) workflowModal.style.display = 'none';
    });


    // --- INITIALIZATION ---

    const initialize = async () => {
        populateStatusDropdown();
        populateMessageTemplates();
        populateWorkflowModal();
        await renderBoard();

        // Add smooth entrance animation
        document.querySelector('header').style.animation = 'slideUp 0.5s ease';
        document.getElementById('board').style.animation = 'slideUp 0.6s ease';
    };

    initialize();
});
